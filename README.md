# object-recognizer

## Structure

  * data: data sources to build a model based upon
    * images: image data
      * negative: collections of background images in different size
        * bg_100x100: 100x100 background images 
        * bg_200x200: 200x200 background images
        * bg_640x480: 480x640 original random source images
      * positive: collections of positive images for different objects
        * cans: images of different kinds of soda cans
          * prepared: cropped, resized, grayscaled soda can images
          * source: source image of cans
        * coffee_cups: images of a peets coffee cup
          * prepared: cropped, resized, grayscaled soda can images
          * source: source image of cans  
  * model: includes trainer and constructed model
    * cascade: cascade classifier trainer and its model
      * cascade_generator: generate cascade
        * bin
          * build_train.py: prepare all files required to train
        * positive_images: should contain processed positive images
        * tools
          * mergevec.py: merge all vector files generate in the process of build trainning prep
        * negative_images: should contain processed negative images
      * cascade_storage: store cascades generated by cascade_generater
        * result: all the xml files generated by the cascade training
        * generator: set of scripts/files used generating the cascade
      * cascade_testor: test stored cascades
        * cascade: cascade files to be included in the testing
        * testCascadeRT: testing cascades files 
  * util: generic scripts for other programs
    * bin: conduct all necessary precondition tasks for building training
      * prepare.py: grayscale and resize source positive
    * libs: collection of program to conduct individual precondition tasks
      * gray_scaller: grayscale source images
      * resizer: resize images
      * collect_resizer: collect images from a URL of ImageNet and resize images
      * collector: collect images from ImageNet
    * cascade_sampling: obsolute folders/files for initial cascade training attempt

## Cascade Classification Intro

To find a particular object, we decided to use Haar-Cascade Classifiers. [This Self Driving RC Car by Zheng Wang](https://zhengludwig.wordpress.com/projects/self-driving-rc-car/) explains how to implement real-time object detection with Haar-Cascade Classifiers. More details on how to train the classifier can be found in [a post by Thorsten Ball](http://coding-robin.de/2013/07/22/train-your-own-opencv-haar-classifier.html).

OpenCV supports Cascade Classification. [Official OpenCV Document](http://docs.opencv.org/2.4/modules/objdetect/doc/cascade_classification.html) on Cascade Classification gives explanation about its theoritical background and implementation. Cascade Classifier Training process is explained [here](http://docs.opencv.org/2.4/doc/user_guide/ug_traincascade.html). I recommend to refer to the official document when actually implementing the Cascade Classifier with OpenCV.

Quick note on Cascade Classifier with OpenCV:

  * To train, we separate training data to positive examples and negative ones.
  * Positive exampels should include the target object.
  * Depending on the generalization level of the object, we need more positive examples to train.
  ie. to recognize faces, we need hundreds or even thousands of images of faces with variety features.
  * Positive examples can be generated from one or a few images with OpenCV build-in function, opencv_createsamples.
  * Negative examples must not include the target object.
  * Negative examples should be made manually.
  * Negative examples sometimes called background samples or background sample images.
  * Opencv provides many command line arguments to prepare examples for classification.
  * To capture images from a video, OpenCV has VideoCapture function.
  * OpenCV, opencv_traincascade, fucntion [train prepared examples](http://docs.opencv.org/2.4/modules/highgui/doc/reading_and_writing_images_and_video.html#videocapture-set).
  1. Common arguments: specify basic information to train.
  2. Cascade parameters: specify stage type (only boosted classifier is supported today), feature type (Haar-like feature olocal binary petterns), and width and height (should exactly same values as used during training samples creation).
  3. Boosted classfier parameters: type, minimal desired hit rate, max false alarm rate, weight trim rate, max depth, anmax weak count.
  4. Haar-like feature parameters: mode (BASIC:use only upright features, or ALL:full set of upright and 45 degree rotatefeature set).
  5. Local Binary Patterns parameters: no param available


## Cascade Classifier Training Process (Commands and Arguments)

1. Get negative sample images and put it in './negative_images' (NOT containing object that you want to recognize)
2. Get source positive sample images and put it in './positive_images' (containing object that you want to recognize)
3. To generate vec files from the samples, run 

      `$ python bin/build_train.py`

4. Conduct cascade training

      `$ opencv_traincascade -data classifier -vec object.vec -bg negatives.txt -numStages 15 -numPos 2000 -numNeg 1000 -w 30 -h 60 -mode ALL -precalcValBufSize 1024 -precalcIdxBufSize 1024`

## Cascade Training Benchmark 

- 16GB (8 CPU) on Digital Ocean
  - 20x20: gained nearly 10e-5 at stage 25 for about 10 hours running.
    - result of cascade quality: only sensitive to the 20x20 scale window.
    - to find cans standing up or lying down, need different cascades for eash.
  - 20x40: in progress
  - 40x20: to do

Since the code of cascade training itself is not optimzed for multi-core processing, it may not be possible to improve the computation time by adding more cores on the DigitalOcean server. Benchmark is for varyfing this assumption.

Be aware that to train, the size of positive image should be the same for the arguments -w and -h in the whole process of training. If you have multiple positive images, you should crop the image in the same ratio of width and height.

The cascade works well in the dark background for now. May be we should make the cascade background color configuration to be inverted so that the bright color foregorund cans turning to be dark on the bright background.

Building benchmarking tools is in progress of designing.

## Test Cascade

$ python testCascadeRealTime.py {cascade object width} {cascade object height} {scale factor} {minimum neighbors} {webcam frame width} {webcam frame height}

For example,

$ python testCascadeRealTime.py 20 50 1.1 22 800 600

## References:

[How to Install OpenCV on Ubuntu](http://www.pyimagesearch.com/2016/10/24/ubuntu-16-04-how-to-install-opencv/) - How to instlal OpenCV on your machine.

[Cascade Classifier Training](http://docs.opencv.org/2.4/doc/user_guide/ug_traincascade.html#positive-samples) - Official document of cascade training by OpenCV 2.4

[Official Tutorial for Cascade Training](http://docs.opencv.org/3.2.0/dc/d88/tutorial_traincascade.html) - Official document of cascade training by OpenCV 3.0+

[Tutorial: OpenCV haartraining (Rapid Object Detection With A Cascade of Boosted Classifiers Based on Haar-like Features)](http://note.sonots.com/SciSoftware/haartraining.html) - Detailed cascade training process including optimal training configuration insights.

[Creating your own Haar Cascade OpenCV Python Tutorial](https://pythonprogramming.net/haar-cascade-object-detection-python-opencv-tutorial/) - Step by step guide to create first cascade training on Python.

[Train your own OpenCV Haar classifier](https://github.com/mrnugget/opencv-haar-classifier-training) - Another well written step by step guide to train cascade. Original source of the vecter merge code.

[Strategy to Make Cascade Training Fast](http://answers.opencv.org/question/7141/about-traincascade-paremeters-samples-and-other/) - Explains insights to configure the parameters better to get more accurate result of traininig.