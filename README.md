# object-recognizer

## Structure

  * data: data sources to build a model based upon
    * images: image data
      * coffee_cups: peets coffee cup data for cascade testing
      * random: random images to be used as negatives
      * cans: images of different kinds of soda cans
        * coke: images of coke cans
  * model: includes trainer and constructed model
    * cascade: cascade classifier trainer and its model
      * cascade_generator: generate cascade
      * cascade_storage: store cascades generated by cascade_generater
        * result: all the xml files generated by the cascade training
        * generator: set of scripts/files used generating the cascade
      * cascade_testor: test stored cascades
  * util: generic scripts for other programs
    * collectResizer: collect images from a URL of ImageNet and resize images
    * collector: collect images from ImageNet
    * resizer: resize images
    * cascade_sampling: obsolute folders/files for initial cascade training attempt

## Cascade Classification Intro

To find a particular object, we decided to use Haar-Cascade Classifiers. [This Self Driving RC Car by Zheng Wang](https://zhengludwig.wordpress.com/projects/self-driving-rc-car/) explains how to implement real-time object detection with Haar-Cascade Classifiers. More details on how to train the classifier can be found in [a post by Thorsten Ball](http://coding-robin.de/2013/07/22/train-your-own-opencv-haar-classifier.html).

OpenCV supports Cascade Classification. [Official OpenCV Document](http://docs.opencv.org/2.4/modules/objdetect/doc/cascade_classification.html) on Cascade Classification gives explanation about its theoritical background and implementation. Cascade Classifier Training process is explained [here](http://docs.opencv.org/2.4/doc/user_guide/ug_traincascade.html). I recommend to refer to the official document when actually implementing the Cascade Classifier with OpenCV.

Quick note on Cascade Classifier with OpenCV:

  * To train, we separate training data to positive examples and negative ones.
  * Positive exampels should include the target object.
  * Depending on the generalization level of the object, we need more positive examples to train.
  ie. to recognize faces, we need hundreds or even thousands of images of faces with variety features.
  * Positive examples can be generated from one or a few images with OpenCV build-in function, opencv_createsamples.
  * Negative examples must not include the target object.
  * Negative examples should be made manually.
  * Negative examples sometimes called background samples or background sample images.
  * Opencv provides many command line arguments to prepare examples for classification.
  * To capture images from a video, OpenCV has VideoCapture function.
  * OpenCV, opencv_traincascade, fucntion [train prepared examples](http://docs.opencv.org/2.4/modules/highgui/doc/reading_and_writing_images_and_video.html#videocapture-set).
  1. Common arguments: specify basic information to train.
  2. Cascade parameters: specify stage type (only boosted classifier is supported today), feature type (Haar-like feature olocal binary petterns), and width and height (should exactly same values as used during training samples creation).
  3. Boosted classfier parameters: type, minimal desired hit rate, max false alarm rate, weight trim rate, max depth, anmax weak count.
  4. Haar-like feature parameters: mode (BASIC:use only upright features, or ALL:full set of upright and 45 degree rotatefeature set).
  5. Local Binary Patterns parameters: no param available

To be accurate, 1000 positives and 5000 negatives are suggested in some articles.

## Cascade Classifier Training Process (Commands and Arguments)

1. Get negative sample images and put it in './negative_images' (NOT containing object that you want to recognize)
2. Get source positive sample images and put it in './positive_images' (containing object that you want to recognize)
3. Generate .txt for negative samples 
      `$ find ./negative_images -iname "*.jpg" > negatives.txt`
4. Generate .txt for positive samples 
      `$ find ./positive_images -iname "*.jpg" > positives.txt`
5. To generate vec files from the samples, run 
      `$ perl bin/createsamples.pl positives.txt negatives.txt samples 3000 "opencv_createsamples -bgcolor 0 -bgthresh 0 -maxxangle 1.1 -maxyangle 1.1 maxzangle 0.5 -maxidev 40 -w 40 -h 80"`
6. To merge the multiple vector files into one, run
      `$ python ./tools/mergevec.py -v samples/ -o samples.vec`
7. Conduct cascade training
      `$ mkdir classifier`
      `$ opencv_traincascade -data classifier -vec object.vec -bg negatives.txt -numStages 15 -numPos 2000 -numNeg 1000 -w 30 -h 60 -mode ALL -precalcValBufSize 1024 -precalcIdxBufSize 1024`


## Cascade Training Benchmark 

- 16GB (8 CPU) on Digital Ocean
  - -w 40 -h 80
  - 2048 buffer size
    - Result: precalculation time = 37, 
  - 4056 buffer size
    - 1: 
      - Result: precalculation time = 64, 
    - 2: 
      - Result: precalculation time = 48, 

Since the code of cascade training itself is not optimzed for multi-core processing, it may not be possible to improve the computation time by adding more cores on the DigitalOcean server. Benchmark is for varyfing this assumption.

## Test Cascade

$ python testCascadeRealTime.py 20 50 1.1 22 800 600
$ python testCascadeRealTime.py {cascade object width} {cascade object height} {scale factor} {minimum neighbors} {webcam frame width} {webcam frame height}

## References:

[Tutorial: OpenCV harrtraining(Rapid Object Detection with a Cascade of Boosted Classifiers Based on Haar-like Features.)](note.sonots.com/SciSoftware/haartraining.html)

[Train Your Own OpenCV Haar Classifier](http://coding-robin.de/2013/07/22/train-your-own-opencv-haar-classifier.html) : with js script to test cascade file for static files with box drawing around target object.

[How to Install OpenCV on Ubuntu](http://www.pyimagesearch.com/2016/10/24/ubuntu-16-04-how-to-install-opencv/)

[Creating a Cascade of Haar-Like Classifiers: Step by Step](https://www.cs.auckland.ac.nz/~m.rezaei/Tutorials/Creating_a_Cascade_of_Haar-Like_Classifiers_Step_by_Step.pdf)

[Haar Cascade Training Tutorial](http://www.trevorsherrard.com/Haar_training.html) : with python script to test cascade file using webcam in real-time with box drawing around target object.

[Cascade Classifier Training](http://docs.opencv.org/2.4/doc/user_guide/ug_traincascade.html#positive-samples)

[Using AWS to Train Cascade Classifier](https://github.com/kburnham/DAND-Right-Whale-Identification/blob/master/Using%20AWS%20to%20Train%20a%20Cascade%20Classifier.md)

[Creating your own Haar Cascade OpenCV Python Tutorial](https://pythonprogramming.net/haar-cascade-object-detection-python-opencv-tutorial/)

[Train your own OpenCV Haar classifier](https://github.com/mrnugget/opencv-haar-classifier-training)

[Strategy to Make Cascade Training Fast](http://answers.opencv.org/question/7141/about-traincascade-paremeters-samples-and-other/) 